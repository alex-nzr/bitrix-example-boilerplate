{"version":3,"file":"index.bundle.js","sources":["../src/scripts/entity-detail-manager.js"],"sourcesContent":["/**\n * ==================================================\n * Developer: Alexey Nazarov\n * E-mail: alsnazarov@1cbit.ru\n * Copyright (c) 2019 - 2022\n * ==================================================\n * gpnsm - ui-detail.js\n * 20.02.2023 21:46\n * ==================================================\n */\nimport { Type, Dom, Tag, Loc } from \"main.core\";\nimport { StageFlow } from 'ui.stageflow';\n\nexport default class EntityDetailManager\n{\n\tconstructor(options = {}) {\n\t\tthis.moduleId \t\t\t \t \t = options.moduleId;\n\t\tthis.typeId \t\t\t \t \t = options.typeId;\n\t\tthis.entityTypeId \t\t \t \t = options.entityTypeId;\n\t\tthis.entityId \t\t\t \t \t = options.entityId;\n\t\tthis.isNew\t\t\t\t \t \t = options.isNew;\n\t\tthis.pageTitleEditable \t\t \t = options.pageTitleEditable;\n\t\tthis.enableCategorySelector   \t = options.enableCategorySelector;\n\t\tthis.cardConfigEditable \t \t = options.cardConfigEditable;\n\t\tthis.enableSectionCreation \t \t = options.enableSectionCreation;\n\t\tthis.enableSectionEdit \t\t \t = options.enableSectionEdit;\n\t\tthis.enableFieldsContextMenu \t = options.enableFieldsContextMenu;\n\t\tthis.enableSectionEditMode \t \t = options.enableSectionEditMode;\n\t\tthis.showEmptySections \t\t \t = options.showEmptySections;\n\t\tthis.enableCommunicationControls = options.enableCommunicationControls;\n\t\tthis.hideTimelineInCreationPage  = options.hideTimelineInCreationPage;\n\t\tthis.isStageFlowActive\t\t\t = options.isStageFlowActive;\n\n\t\tthis.init();\n\t}\n\n\tinit() {\n\t\tthis.customizeStageFlow();\n\t\tthis.customizePageTitleBlock();\n\t\tthis.addCssClasses();\n\t\tthis.initEvents();\n\t}\n\n\tinitEvents(){\n\t\tBX.ready(() => {\n\n\t\t\tBX.addCustomEvent('BX.Crm.EntityEditor:onBeforeLayout', (editor) => {\n\t\t\t\tif (!this.enableCommunicationControls)\n\t\t\t\t{\n\t\t\t\t\teditor._enableCommunicationControls = false;\n\t\t\t\t}\n\n\t\t\t\tif (!this.cardConfigEditable)\n\t\t\t\t{\n\t\t\t\t\tif (editor._config)\n\t\t\t\t\t{\n\t\t\t\t\t\teditor._enableConfigControl = false;\n\t\t\t\t\t\teditor._config._canUpdateCommonConfiguration = false;\n\t\t\t\t\t\teditor._config._canUpdatePersonalConfiguration = false;\n\t\t\t\t\t\teditor._config._enableScopeToggle = false;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!this.enableSectionCreation)\n\t\t\t\t{\n\t\t\t\t\teditor._enableSectionCreation = false;\n\t\t\t\t}\n\n\t\t\t\tif (!this.cardConfigEditable && !this.enableSectionCreation)\n\t\t\t\t{\n\t\t\t\t\teditor._enableBottomPanel = false;\n\t\t\t\t}\n\n\t\t\t\tif (!this.enableSectionEdit)\n\t\t\t\t{\n\t\t\t\t\teditor._enableSectionEdit = false;\n\t\t\t\t}\n\n\t\t\t\tif (!this.enableFieldsContextMenu)\n\t\t\t\t{\n\t\t\t\t\teditor._enableFieldsContextMenu = false;\n\t\t\t\t}\n\n\t\t\t\tif (!this.pageTitleEditable)\n\t\t\t\t{\n\t\t\t\t\teditor._enablePageTitleControls = false;\n\t\t\t\t\teditor._model && (editor._model.isCaptionEditable = () => false);\n\t\t\t\t}\n\n\t\t\t\tif (editor.getMode() === BX.UI.EntityEditorMode.edit)\n\t\t\t\t{\n\t\t\t\t\t//setTimeout(() => editor.cancel(), 5000);\n\t\t\t\t}\n\n\t\t\t\teditor.saveScheme();\n\t\t\t});\n\n\t\t\tBX.addCustomEvent('BX.Crm.EntityEditorSection:onLayout', (section) => {\n\t\t\t\tif (section.getMode() === BX.UI.EntityEditorMode.edit)\n\t\t\t\t{\n\t\t\t\t\t//section.toggleMode();\n\t\t\t\t}\n\n\t\t\t\tif (!this.enableSectionEditMode)\n\t\t\t\t{\n\t\t\t\t\tBX.type.isDomNode(section._titleActions) ? section._titleActions.remove() : void(0);\n\n\t\t\t\t\tsection._schemeElement._isEditable = false;\n\t\t\t\t\tsection.saveScheme();\n\t\t\t\t}\n\n\t\t\t\tif (!this.showEmptySections)\n\t\t\t\t{\n\t\t\t\t\tconst fields = section.getChildren();\n\t\t\t\t\tif (fields.length <= 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tif(BX.type.isDomNode(section._wrapper))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tsection._wrapper.classList.add('ui-element-hidden');\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t/*fields.forEach(field => {\n                    prepareFieldParams(field);\n                });*/\n\t\t\t})\n\n\t\t\t/*BX.addCustomEvent('BX.UI.EntityEditorField:onLayout', (field) => {\n                prepareFieldParams(field);\n            });\n\n            function prepareFieldParams(field)\n            {\n                if(readonlyFields.includes(field._id))\n                {\n                    field._schemeElement._isEditable=false;\n                    field.saveScheme();\n\n                    const inputs = field._wrapper.querySelectorAll(`[name^='`+field._id+`'], [name^='`+field._id+`[]'], i.date.icon`);\n                    inputs.length && inputs.forEach(input => {\n                        input.setAttribute('disabled', true);\n                        input.onclick = () => false;\n                    });\n                }\n            }*/\n\n\t\t\t//BX.Crm.EntityEditorColumn\n\t\t\t//BX.Crm.EntityEditorSection\n\t\t\t//BX.Crm.EntityEditor.getDefault()._enableModeToggle = false;\n\t\t\t//BX.UI.EntityEditorMode = {\n\t\t\t//    \"intermediate\": 0,\n\t\t\t//    \"edit\": 1,\n\t\t\t//    \"view\": 2,\n\t\t\t//    \"names\": {\n\t\t\t//        \"view\": \"view\",\n\t\t\t//        \"edit\": \"edit\"\n\t\t\t//    }\n\t\t\t//};\n\t\t});\n\t}\n\n\taddCssClasses() {\n\t\tif (this.isNew)\n\t\t{\n\t\t\tdocument.body.classList.add('editor-mode-new-item-creation');\n\t\t\tif (this.hideTimelineInCreationPage)\n\t\t\t{\n\t\t\t\tdocument.body.classList.add('editor-mode-hide-timeline-column');\n\t\t\t}\n\t\t}\n\t}\n\n\tcustomizePageTitleBlock(){\n\t\tif (!BX.Crm?.ItemDetailsComponent)\n\t\t{\n\t\t\tconsole.log('BX.Crm.ItemDetailsComponent is undefined')\n\t\t\treturn;\n\t\t}\n\n\t\tconst entityDetailManager = this;\n\n\t\tBX.Crm.ItemDetailsComponent.prototype.initPageTitleButtons = function()\n\t\t{\n\t\t\tconst pageTitleButtons = Tag.render`\n\t\t\t\t<span id=\"pagetitle_btn_wrapper\" class=\"pagetitile-button-container\">\n\t\t\t\t\t<span id=\"page_url_copy_btn\" class=\"crm-page-link-btn\"></span>\n\t\t\t\t</span>\n\t\t\t`;\n\n\t\t\tif (entityDetailManager.pageTitleEditable)\n\t\t\t{\n\t\t\t\tconst editButton = Tag.render`\n\t\t\t\t\t<span id=\"pagetitle_edit\" class=\"pagetitle-edit-button\"></span>\n\t\t\t\t`;\n\t\t\t\tDom.prepend(editButton, pageTitleButtons);\n\t\t\t}\n\n\t\t\tconst pageTitle = document.getElementById('pagetitle');\n\t\t\tDom.insertAfter(pageTitleButtons, pageTitle);\n\n\t\t\tif (entityDetailManager.enableCategorySelector)\n\t\t\t{\n\t\t\t\tif(Type.isArray(this.categories) && this.categories.length > 0)\n\t\t\t\t{\n\t\t\t\t\tconst currentCategory = this.getCurrentCategory();\n\t\t\t\t\tif(currentCategory)\n\t\t\t\t\t{\n\t\t\t\t\t\tconst categoriesSelector = Tag.render`\n\t\t\t\t\t\t\t<div id=\"pagetitle_sub\" class=\"pagetitle-sub\">\n\t\t\t\t\t\t\t\t<a href=\"#\" onclick=\"${this.onCategorySelectorClick.bind(this)}\">${currentCategory.text}</a>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t`;\n\n\t\t\t\t\t\tDom.insertAfter(categoriesSelector, pageTitleButtons);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tcustomizeStageFlow() {\n\t\tif (!BX.Crm?.ItemDetailsComponent)\n\t\t{\n\t\t\tconsole.log('BX.Crm.ItemDetailsComponent is undefined')\n\t\t\treturn;\n\t\t}\n\n\t\tconst entityDetailManager = this;\n\n\t\tBX.Crm.ItemDetailsComponent.prototype.initStageFlow = function()\n\t\t{\n\t\t\tconst BACKGROUND_COLOR = 'd3d7dc';\n\t\t\tif(this.stages)\n\t\t\t{\n\t\t\t\tconst flowStagesData = this.prepareStageFlowStagesData();\n\t\t\t\tconst stageFlowContainer = document.querySelector('[data-role=\"stageflow-wrap\"]');\n\t\t\t\tif(stageFlowContainer)\n\t\t\t\t{\n\t\t\t\t\tif (!entityDetailManager.isStageFlowActive)\n\t\t\t\t\t{\n\t\t\t\t\t\tstageFlowContainer.classList.add('ui-element-disabled');\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.stageflowChart = new StageFlow.Chart({\n\t\t\t\t\t\tbackgroundColor: BACKGROUND_COLOR,\n\t\t\t\t\t\tcurrentStage: this.currentStageId,\n\t\t\t\t\t\tisActive: entityDetailManager.isStageFlowActive,\n\t\t\t\t\t\tonStageChange: this.onStageChange.bind(this),\n\t\t\t\t\t\tlabels: {\n\t\t\t\t\t\t\tfinalStageName: Loc.getMessage('CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_NAME'),\n\t\t\t\t\t\t\tfinalStagePopupTitle: Loc.getMessage('CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_POPUP'),\n\t\t\t\t\t\t\tfinalStagePopupFail: Loc.getMessage('CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_POPUP_FAIL'),\n\t\t\t\t\t\t\tfinalStageSelectorTitle: Loc.getMessage('CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_SELECTOR'),\n\t\t\t\t\t\t},\n\t\t\t\t\t}, flowStagesData);\n\t\t\t\t\tstageFlowContainer.appendChild(this.stageflowChart.render());\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}"],"names":["EntityDetailManager","options","moduleId","typeId","entityTypeId","entityId","isNew","pageTitleEditable","enableCategorySelector","cardConfigEditable","enableSectionCreation","enableSectionEdit","enableFieldsContextMenu","enableSectionEditMode","showEmptySections","enableCommunicationControls","hideTimelineInCreationPage","isStageFlowActive","init","customizeStageFlow","customizePageTitleBlock","addCssClasses","initEvents","BX","ready","addCustomEvent","editor","_this","_enableCommunicationControls","_config","_enableConfigControl","_canUpdateCommonConfiguration","_canUpdatePersonalConfiguration","_enableScopeToggle","_enableSectionCreation","_enableBottomPanel","_enableSectionEdit","_enableFieldsContextMenu","_enablePageTitleControls","_model","isCaptionEditable","getMode","UI","EntityEditorMode","edit","saveScheme","section","type","isDomNode","_titleActions","remove","_schemeElement","_isEditable","getChildren","length","_wrapper","classList","add","this","document","body","Crm","_BX$Crm","ItemDetailsComponent","entityDetailManager","prototype","initPageTitleButtons","pageTitleButtons","Tag","render","editButton","Dom","prepend","pageTitle","getElementById","insertAfter","Type","isArray","categories","currentCategory","getCurrentCategory","categoriesSelector","onCategorySelectorClick","bind","text","console","log","_BX$Crm2","initStageFlow","stages","flowStagesData","prepareStageFlowStagesData","stageFlowContainer","querySelector","stageflowChart","StageFlow","Chart","backgroundColor","currentStage","currentStageId","isActive","onStageChange","labels","finalStageName","Loc","getMessage","finalStagePopupTitle","finalStagePopupFail","finalStageSelectorTitle","appendChild"],"mappings":"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"}