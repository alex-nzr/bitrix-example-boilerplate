{"version":3,"file":"index.bundle.js","sources":["../src/scripts/entity-detail-manager.js"],"sourcesContent":["/**\n * ==================================================\n * Developer: Alexey Nazarov\n * E-mail: alsnazarov@1cbit.ru\n * Copyright (c) 2019 - 2022\n * ==================================================\n * gpnsm - ui-detail.js\n * 20.02.2023 21:46\n * ==================================================\n */\nimport { Type, Dom, Tag, Loc } from \"main.core\";\nimport { StageFlow } from 'ui.stageflow';\n\nexport default class EntityDetailManager\n{\n\tconstructor(options = {}) {\n\t\tthis.moduleId \t\t\t \t \t = options.moduleId;\n\t\tthis.typeId \t\t\t \t \t = options.typeId;\n\t\tthis.entityTypeId \t\t \t \t = options.entityTypeId;\n\t\tthis.entityId \t\t\t \t \t = options.entityId;\n\t\tthis.isNew\t\t\t\t \t \t = options.isNew;\n\n\t\t//редактирование названия элемента в заголовке страницы\n\t\tthis.pageTitleEditable \t\t \t = options.pageTitleEditable;\n\n\t\t//кнопка смены воронки около заголовка\n\t\tthis.enableCategorySelector   \t = options.enableCategorySelector;\n\n\t\t//кнопка смены/сохранения общего и перснонального конфига карточки\n\t\t//кнопки выбора полей секции, удаления секции, возможность создавать секции\n\t\tthis.cardConfigEditable \t \t = options.cardConfigEditable;\n\n\t\t//создание новый секций (требует включенной предыдущей опции)\n\t\t//создание секций в режиме создания элемента запрещено, так как иначе сложности со скрытием пустых секций\n\t\tthis.enableSectionCreation \t \t = options.enableSectionCreation && !this.isNew;\n\n\t\t//редактирование названия секции\n\t\tthis.enableSectionEdit \t\t \t = options.enableSectionEdit;\n\n\t\t//кнопка настроек рядом с полем\n\t\tthis.enableFieldsContextMenu \t = options.enableFieldsContextMenu;\n\n\t\t//кнопка изменить и перевод секции в режим редактирования\n\t\t//ВАЖНО: если отключить эту опцию, но включить this.enableSectionCreation,\n\t\t// то новые секции будут создаваться не в режиме редактирования и сразу будут скрытыми\n\t\t//поэтому для корректной работы лучше при включенной this.enableSectionCreation включать и this.enableSectionEditMode\n\t\tthis.enableSectionEditMode \t \t = options.enableSectionEditMode;\n\n\t\t//скрывать секцию если в ней нет видимых полей. Если поле скрыто, потому что нет значения, то секция останется\n\t\tthis.showEmptySections \t\t \t = options.showEmptySections;\n\n\t\t//кнопки коммуникаций в тулбаре (звонок, чат и т.п.)\n\t\tthis.enableCommunicationControls = options.enableCommunicationControls;\n\n\t\t//в режиме создания нового элемента скрывать таймлайн и делать форму на всю страницу\n\t\tthis.hideTimelineInCreationPage  = options.hideTimelineInCreationPage;\n\n\t\t//переключение стадий в шапке страницы\n\t\tthis.isStageFlowActive\t\t\t = options.isStageFlowActive;\n\n\t\t//обновлять контент страницы при смене стадии в шапке.\n\t\t//Для страницы открытой в слайдере будет плавное обновление, для обычной страницы - перезагрузка\n\t\tthis.reloadOnStageChange\t\t = options.reloadOnStageChange;\n\n\t\tthis.init();\n\t}\n\n\tinit() {\n\t\tthis.customizeStageFlow();\n\t\tthis.customizePageTitleBlock();\n\t\tthis.addCssClasses();\n\t\tthis.initEvents();\n\t}\n\n\tinitEvents(){\n\t\tBX.ready(() => {\n\n\t\t\tBX.addCustomEvent('BX.Crm.EntityEditor:onBeforeLayout', (editor) => {\n\t\t\t\tif (!this.enableCommunicationControls)\n\t\t\t\t{\n\t\t\t\t\teditor._enableCommunicationControls = false;\n\t\t\t\t}\n\n\t\t\t\tif (!this.enableSectionCreation)\n\t\t\t\t{\n\t\t\t\t\teditor._enableSectionCreation = false;\n\t\t\t\t}\n\n\t\t\t\tif (!this.cardConfigEditable)\n\t\t\t\t{\n\t\t\t\t\teditor._enableBottomPanel = false;\n\t\t\t\t\teditor._enableConfigControl = false;\n\t\t\t\t\teditor._enableSectionCreation = false;\n\t\t\t\t\tif (editor._config)\n\t\t\t\t\t{\n\t\t\t\t\t\teditor._config._canUpdateCommonConfiguration = false;\n\t\t\t\t\t\teditor._config._canUpdatePersonalConfiguration = false;\n\t\t\t\t\t\teditor._config._enableScopeToggle = false;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!this.enableSectionEdit)\n\t\t\t\t{\n\t\t\t\t\teditor._enableSectionEdit = false;\n\t\t\t\t}\n\n\t\t\t\tif (!this.enableFieldsContextMenu)\n\t\t\t\t{\n\t\t\t\t\teditor._enableFieldsContextMenu = false;\n\t\t\t\t}\n\n\t\t\t\tif (!this.pageTitleEditable)\n\t\t\t\t{\n\t\t\t\t\teditor._enablePageTitleControls = false;\n\t\t\t\t\teditor._model && (editor._model.isCaptionEditable = () => false);\n\t\t\t\t}\n\n\t\t\t\tif (editor.getMode() === BX.UI.EntityEditorMode.edit)\n\t\t\t\t{\n\t\t\t\t\t//setTimeout(() => editor.cancel(), 5000);\n\t\t\t\t}\n\n\t\t\t\teditor.saveScheme();\n\t\t\t});\n\n\t\t\tBX.addCustomEvent('BX.Crm.EntityEditorSection:onLayout', (section) => {\n\t\t\t\tif (!this.enableSectionEditMode)\n\t\t\t\t{\n\t\t\t\t\tsection.getSchemeElement().setDataParam('enableToggling', false);\n\t\t\t\t}\n\n\t\t\t\t//section.getSchemeElement().setDataParam('isRemovable', false);//запрет удаления секции\n\t\t\t\t//section.getSchemeElement().setDataParam('isChangeable', false);//запрет выбора полей\n\n\t\t\t\tsection.saveScheme();\n\n\t\t\t\tconst fields = section.getChildren();\n\t\t\t\tif (fields.length <= 0)\n\t\t\t\t{\n\t\t\t\t\tif (!this.showEmptySections)\n\t\t\t\t\t{\n\t\t\t\t\t\tif(BX.type.isDomNode(section._wrapper))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tsection._wrapper.classList.add('ui-element-hidden');\n\t\t\t\t\t\t\tif (this.isNew)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t//for hide empty sections while new item creation running\n\t\t\t\t\t\t\t\tsection._wrapper.classList.remove('ui-entity-editor-section-edit');\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\n\t\t\tBX.addCustomEvent('BX.Crm.ItemDetailsComponent:onStageChange', () => {\n\t\t\t\tif(this.reloadOnStageChange)\n\t\t\t\t{\n\t\t\t\t\tif (BX.SidePanel?.Instance?.opened)\n\t\t\t\t\t{\n\t\t\t\t\t\tBX.SidePanel.Instance.reload();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\twindow.location.reload();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\taddCssClasses() {\n\t\tif (this.isNew)\n\t\t{\n\t\t\tdocument.body.classList.add('editor-mode-new-item-creation');\n\t\t\tif (this.hideTimelineInCreationPage)\n\t\t\t{\n\t\t\t\tdocument.body.classList.add('editor-mode-hide-timeline-column');\n\t\t\t}\n\t\t}\n\t}\n\n\tcustomizePageTitleBlock(){\n\t\tif (!BX.Crm?.ItemDetailsComponent)\n\t\t{\n\t\t\tconsole.log('BX.Crm.ItemDetailsComponent is undefined')\n\t\t\treturn;\n\t\t}\n\n\t\tconst entityDetailManager = this;\n\n\t\tBX.Crm.ItemDetailsComponent.prototype.initPageTitleButtons = function()\n\t\t{\n\t\t\tconst pageTitleButtons = Tag.render`\n\t\t\t\t<span id=\"pagetitle_btn_wrapper\" class=\"pagetitile-button-container\">\n\t\t\t\t\t<span id=\"page_url_copy_btn\" class=\"crm-page-link-btn\"></span>\n\t\t\t\t</span>\n\t\t\t`;\n\n\t\t\tif (entityDetailManager.pageTitleEditable)\n\t\t\t{\n\t\t\t\tconst editButton = Tag.render`\n\t\t\t\t\t<span id=\"pagetitle_edit\" class=\"pagetitle-edit-button\"></span>\n\t\t\t\t`;\n\t\t\t\tDom.prepend(editButton, pageTitleButtons);\n\t\t\t}\n\n\t\t\tconst pageTitle = document.getElementById('pagetitle');\n\t\t\tDom.insertAfter(pageTitleButtons, pageTitle);\n\n\t\t\tif (entityDetailManager.enableCategorySelector)\n\t\t\t{\n\t\t\t\tif(Type.isArray(this.categories) && this.categories.length > 0)\n\t\t\t\t{\n\t\t\t\t\tconst currentCategory = this.getCurrentCategory();\n\t\t\t\t\tif(currentCategory)\n\t\t\t\t\t{\n\t\t\t\t\t\tconst categoriesSelector = Tag.render`\n\t\t\t\t\t\t\t<div id=\"pagetitle_sub\" class=\"pagetitle-sub\">\n\t\t\t\t\t\t\t\t<a href=\"#\" onclick=\"${this.onCategorySelectorClick.bind(this)}\">${currentCategory.text}</a>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t`;\n\n\t\t\t\t\t\tDom.insertAfter(categoriesSelector, pageTitleButtons);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tcustomizeStageFlow() {\n\t\tif (!BX.Crm?.ItemDetailsComponent)\n\t\t{\n\t\t\tconsole.log('BX.Crm.ItemDetailsComponent is undefined')\n\t\t\treturn;\n\t\t}\n\n\t\tconst entityDetailManager = this;\n\n\t\tBX.Crm.ItemDetailsComponent.prototype.initStageFlow = function()\n\t\t{\n\t\t\tconst BACKGROUND_COLOR = 'd3d7dc';\n\t\t\tif(this.stages)\n\t\t\t{\n\t\t\t\tconst flowStagesData = this.prepareStageFlowStagesData();\n\t\t\t\tconst stageFlowContainer = document.querySelector('[data-role=\"stageflow-wrap\"]');\n\t\t\t\tif(stageFlowContainer)\n\t\t\t\t{\n\t\t\t\t\tif (!entityDetailManager.isStageFlowActive)\n\t\t\t\t\t{\n\t\t\t\t\t\tstageFlowContainer.classList.add('ui-element-disabled');\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.stageflowChart = new StageFlow.Chart({\n\t\t\t\t\t\tbackgroundColor: BACKGROUND_COLOR,\n\t\t\t\t\t\tcurrentStage: this.currentStageId,\n\t\t\t\t\t\tisActive: entityDetailManager.isStageFlowActive,\n\t\t\t\t\t\tonStageChange: this.onStageChange.bind(this),\n\t\t\t\t\t\tlabels: {\n\t\t\t\t\t\t\tfinalStageName: Loc.getMessage('CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_NAME'),\n\t\t\t\t\t\t\tfinalStagePopupTitle: Loc.getMessage('CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_POPUP'),\n\t\t\t\t\t\t\tfinalStagePopupFail: Loc.getMessage('CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_POPUP_FAIL'),\n\t\t\t\t\t\t\tfinalStageSelectorTitle: Loc.getMessage('CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_SELECTOR'),\n\t\t\t\t\t\t},\n\t\t\t\t\t}, flowStagesData);\n\t\t\t\t\tstageFlowContainer.appendChild(this.stageflowChart.render());\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}"],"names":["EntityDetailManager","options","moduleId","typeId","entityTypeId","entityId","isNew","pageTitleEditable","enableCategorySelector","cardConfigEditable","enableSectionCreation","this","enableSectionEdit","enableFieldsContextMenu","enableSectionEditMode","showEmptySections","enableCommunicationControls","hideTimelineInCreationPage","isStageFlowActive","reloadOnStageChange","init","customizeStageFlow","customizePageTitleBlock","addCssClasses","initEvents","BX","ready","addCustomEvent","editor","_this","_enableCommunicationControls","_enableSectionCreation","_enableBottomPanel","_enableConfigControl","_config","_canUpdateCommonConfiguration","_canUpdatePersonalConfiguration","_enableScopeToggle","_enableSectionEdit","_enableFieldsContextMenu","_enablePageTitleControls","_model","isCaptionEditable","getMode","UI","EntityEditorMode","edit","saveScheme","section","getSchemeElement","setDataParam","getChildren","length","type","isDomNode","_wrapper","classList","add","remove","SidePanel","_BX$SidePanel","Instance","_BX$SidePanel$Instanc","opened","reload","window","location","document","body","Crm","_BX$Crm","ItemDetailsComponent","entityDetailManager","prototype","initPageTitleButtons","pageTitleButtons","Tag","render","editButton","Dom","prepend","pageTitle","getElementById","insertAfter","Type","isArray","categories","currentCategory","getCurrentCategory","categoriesSelector","onCategorySelectorClick","bind","text","console","log","_BX$Crm2","initStageFlow","stages","flowStagesData","prepareStageFlowStagesData","stageFlowContainer","querySelector","stageflowChart","StageFlow","Chart","backgroundColor","currentStage","currentStageId","isActive","onStageChange","labels","finalStageName","Loc","getMessage","finalStagePopupTitle","finalStagePopupFail","finalStageSelectorTitle","appendChild"],"mappings":"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"}